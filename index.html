<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OE3LCR - Ham Radio Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <!-- Favicon - Neon Green Ham Radio Antenna (Data-URI) -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Crect width='200' height='200' fill='%230a0a0f'/%3E%3Cdefs%3E%3Cfilter id='glow'%3E%3CfeGaussianBlur stdDeviation='3' result='coloredBlur'/%3E%3CfeMerge%3E%3CfeMergeNode in='coloredBlur'/%3E%3CfeMergeNode in='SourceGraphic'/%3E%3C/feMerge%3E%3C/filter%3E%3C/defs%3E%3Cline x1='100' y1='30' x2='100' y2='120' stroke='%2300ff88' stroke-width='6' stroke-linecap='round' filter='url(%23glow)'/%3E%3Cline x1='100' y1='60' x2='60' y2='100' stroke='%2300ff88' stroke-width='5' stroke-linecap='round' filter='url(%23glow)'/%3E%3Cline x1='100' y1='60' x2='140' y2='100' stroke='%2300ff88' stroke-width='5' stroke-linecap='round' filter='url(%23glow)'/%3E%3Cline x1='40' y1='140' x2='160' y2='140' stroke='%2300ff88' stroke-width='4' stroke-linecap='round' filter='url(%23glow)'/%3E%3Cline x1='60' y1='140' x2='100' y2='120' stroke='%2300ff88' stroke-width='4' stroke-linecap='round' filter='url(%23glow)'/%3E%3Cline x1='140' y1='140' x2='100' y2='120' stroke='%2300ff88' stroke-width='4' stroke-linecap='round' filter='url(%23glow)'/%3E%3Ccircle cx='100' cy='160' r='15' fill='none' stroke='%2300ff88' stroke-width='2' opacity='0.6' filter='url(%23glow)'/%3E%3Ccircle cx='100' cy='160' r='25' fill='none' stroke='%2300ff88' stroke-width='1.5' opacity='0.3' filter='url(%23glow)'/%3E%3C/svg%3E">
    <script src="/satellite.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-variant-numeric: tabular-nums;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #0f0f1a 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px; margin-bottom: 20px;
            background: rgba(20, 20, 35, 0.8);
            border-radius: 15px;
            border: 1px solid rgba(0, 255, 136, 0.2);
        }
        .callsign {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5em; font-weight: 700;
            color: #00ff88;
            text-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
        }
        .datetime { text-align: right; }
        .time {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-weight: 700;
            font-size: 2.5em; color: #ff6b35;
            text-shadow: 0 0 15px rgba(255, 107, 53, 0.5);
            letter-spacing: 0.05em;
            font-variant-numeric: tabular-nums;
        }
        .date { font-size: 1.2em; color: #888; }
        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .sun-display {
            background: rgba(20, 20, 35, 0.9);
            border-radius: 15px;
            padding: 30px;
            border: 2px solid rgba(255, 165, 2, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .sun-container {
            width: 450px;
            height: 450px;
            margin: 15px 0;
            border-radius: 50%;
            overflow: hidden;
        }
        .sun-image {
            width: 100%;
            height: 100%;
            box-shadow: 0 0 80px rgba(255, 165, 2, 0.6);
            object-fit: cover;
        }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .card {
            background: rgba(20, 20, 35, 0.9);
            border-radius: 15px; padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .card-header {
            display: flex; align-items: center; gap: 10px;
            margin-bottom: 15px; padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .card-header .icon { font-size: 1.2em; }
        .card-title {
            font-size: 0.9em; text-transform: uppercase;
            letter-spacing: 2px; color: #ff4757; font-weight: 600;
        }
        .location .grid-square {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 2em; color: #00d4ff; margin-bottom: 10px;
            font-weight: 700;
            letter-spacing: 0.1em;
        }
        .location .coords { color: #888; font-size: 1em; margin-bottom: 10px; }
        .location .celestial-times { display: grid; gap: 8px; margin-top: 10px; }
        .location .celestial-row {
            display: flex; justify-content: space-between;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
        }
        .location .sun-row { color: #ffa502; }
        .location .moon-row { color: #a8dadc; }
        .location .celestial-label { font-size: 0.9em; font-weight: 600; }
        .location .celestial-times-text { font-size: 0.95em; font-variant-numeric: tabular-nums; }
        .location .moon-phase { font-size: 1.2em; margin-right: 8px; }
        .solar-data {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            border-left: 3px solid #ffa502;
        }
        .solar-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 0.95em;
        }
        .solar-label { color: #888; }
        .solar-value { color: #ffa502; font-weight: 600; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .info-box {
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .info-label { font-size: 0.8em; color: #666; text-transform: uppercase; }
        .info-value { font-size: 1.2em; color: #e0e0e0; margin-top: 5px; font-weight: 600; }
        @media (max-width: 1000px) { .main-content { grid-template-columns: 1fr; } }
        /* Band Conditions Grid */
        .band-conditions-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 15px;
        }
        
        .band-box {
            padding: 10px 8px;
            border-radius: 10px;
            text-align: center;
            font-weight: 700;
            border: 1.5px solid;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .band-box:hover {
            transform: translateY(-2px);
        }
        
        /* GOOD - Green/Neon */
        .band-box.good {
            background: rgba(0, 255, 100, 0.08);
            border-color: #00ff64;
            color: #00ff88;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.3), inset 0 0 15px rgba(0, 255, 136, 0.05);
        }
        
        .band-box.good:hover {
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.5), inset 0 0 15px rgba(0, 255, 136, 0.1);
        }
        
        /* FAIR - Orange/Gold */
        .band-box.fair {
            background: rgba(255, 165, 0, 0.08);
            border-color: #ffa502;
            color: #ffb020;
            box-shadow: 0 0 10px rgba(255, 165, 2, 0.3), inset 0 0 15px rgba(255, 165, 2, 0.05);
        }
        
        .band-box.fair:hover {
            box-shadow: 0 0 15px rgba(255, 165, 2, 0.5), inset 0 0 15px rgba(255, 165, 2, 0.1);
        }
        
        /* POOR - Red/Pink */
        .band-box.poor {
            background: rgba(255, 100, 130, 0.08);
            border-color: #ff6482;
            color: #ff7b9c;
            box-shadow: 0 0 10px rgba(255, 100, 130, 0.3), inset 0 0 15px rgba(255, 100, 130, 0.05);
        }
        
        .band-box.poor:hover {
            box-shadow: 0 0 15px rgba(255, 100, 130, 0.5), inset 0 0 15px rgba(255, 100, 130, 0.1);
        }
        
        .band-name {
            font-size: 1.1em;
            font-weight: 800;
            margin-bottom: 3px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-variant-numeric: tabular-nums;
        }
        
        .band-condition {
            font-size: 0.65em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            opacity: 0.9;
            opacity: 0.9;
        }
        
        /* DX Cluster Scrollbar */
        .card:has(> div > div[style*="overflow-y"]) div[style*="overflow-y"] {
            scrollbar-width: thin;
            scrollbar-color: #ffa502 rgba(255, 255, 255, 0.1);
        }
        
        .card:has(> div > div[style*="overflow-y"]) div[style*="overflow-y"]::-webkit-scrollbar {
            width: 8px;
        }
        
        .card:has(> div > div[style*="overflow-y"]) div[style*="overflow-y"]::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .card:has(> div > div[style*="overflow-y"]) div[style*="overflow-y"]::-webkit-scrollbar-thumb {
            background: #ffa502;
            border-radius: 4px;
        }
        .footer { text-align: center; margin-top: 30px; color: #666; font-size: 0.9em; }
        
        /* Setup Modal Styles */
        #setup-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: rgba(20, 20, 35, 0.95);
            border: 2px solid rgba(0, 255, 136, 0.3);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8), 0 0 40px rgba(0, 255, 136, 0.2);
        }
        
        .modal-header {
            font-size: 1.8em;
            font-weight: 700;
            color: #00ff88;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .modal-subtitle {
            color: #aaa;
            text-align: center;
            margin-bottom: 30px;
            font-size: 1em;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #00ff88;
            font-weight: 600;
            font-size: 0.95em;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 1em;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
        }
        
        .modal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn-primary {
            flex: 1;
            padding: 12px 20px;
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            color: #000;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 255, 136, 0.4);
        }
        
        /* Settings Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        .settings-modal-content {
            background: rgba(20, 20, 35, 0.95);
            border: 2px solid rgba(255, 165, 2, 0.3);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8), 0 0 40px rgba(255, 165, 2, 0.2);
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .settings-header h2 {
            color: #ffa502;
            font-size: 1.5em;
            margin: 0;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: #ffa502;
            font-size: 2em;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .settings-info {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #ccc;
        }
        
        .settings-info p {
            margin: 5px 0;
            font-size: 0.95em;
        }
        
        .settings-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn-save {
            padding: 10px;
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            color: #000;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 255, 136, 0.3);
        }
        
        .btn-reset {
            padding: 10px;
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
            border: 1px solid #ff4757;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-reset:hover {
            background: rgba(255, 71, 87, 0.3);
        }
        
        .btn-cancel {
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: #aaa;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            grid-column: 1 / -1;
        }
        
        .btn-cancel:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        /* Settings Button in Header */
        #settings-btn {
            background: rgba(255, 165, 2, 0.2);
            border: 1px solid rgba(255, 165, 2, 0.4);
            color: #ffa502;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.9em;
        }
        
        #settings-btn:hover {
            background: rgba(255, 165, 2, 0.3);
            box-shadow: 0 0 20px rgba(255, 165, 2, 0.2);
        }
        
        /* Mobile Responsive */
        /* Band Conditions Responsive */
        @media (max-width: 1200px) {
            .band-conditions-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
        }
        
        @media (max-width: 900px) {
            .band-conditions-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
        }
        
        @media (max-width: 768px) {
            .modal-content,
            .settings-modal-content {
                padding: 30px 20px;
                max-width: 90vw;
            }
            
            .modal-header {
                font-size: 1.4em;
            }
            
            .form-group input,
            .form-group select {
                padding: 14px;
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            .modal-buttons {
                flex-direction: column;
            }
            
            #settings-btn {
                padding: 10px 12px;
                font-size: 0.85em;
            }
            
            .band-conditions-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .band-box {
                padding: 10px 8px;
            }
            
            .band-name {
                font-size: 1em;
                margin-bottom: 2px;
            }
            
            .band-condition {
                font-size: 0.6em;
            }
        }
        
        @media (max-width: 480px) {
            .band-conditions-grid {
                grid-template-columns: 1fr;
                gap: 6px;
            }
            
            .band-box {
                padding: 8px 6px;
            }
            
            .band-name {
                font-size: 0.9em;
                margin-bottom: 2px;
                letter-spacing: 0.5px;
            }
            
            .band-condition {
                font-size: 0.55em;
            }
        }
    </style>
    <script src="/js/user-settings.js"></script>
    <script>
        // === TRANSLATIONS SYSTEM ===
        const translations = {
            de: {
                header_title: 'üéôÔ∏è HAM RADIO DASHBOARD',
                settings_btn: '‚öôÔ∏è Einstellungen',
                band_legend_title: 'Band Bedingungen:',
                condition_good: 'GOOD - Gute Bedingungen',
                condition_fair: 'FAIR - Mittelm√§√üig',
                condition_poor: 'POOR - Schlecht',
                btn_close: 'Schlie√üen',
                btn_save: 'Speichern',
                btn_reset: 'Zur√ºcksetzen',
                btn_cancel: 'Abbrechen',
                modal_callsign: 'Rufzeichen:',
                modal_locator: 'Maidenhead Locator:',
                modal_language: 'Sprache:',
                modal_setup_title: 'Willkommen! Erste Einrichtung',
                modal_setup_desc: 'Bitte geben Sie Ihre Daten ein:',
                modal_settings_title: 'Einstellungen',
                modal_form_callsign: 'Rufzeichen',
                modal_form_locator: 'Locator',
                weather_quiet: 'Ruhig',
                weather_active: 'Aktiv',
                weather_storm: '‚ö†Ô∏è Sturm',
            },
            en: {
                header_title: 'üéôÔ∏è HAM RADIO DASHBOARD',
                settings_btn: '‚öôÔ∏è Settings',
                band_legend_title: 'Band Conditions:',
                condition_good: 'GOOD - Good conditions',
                condition_fair: 'FAIR - Fair conditions',
                condition_poor: 'POOR - Poor conditions',
                btn_close: 'Close',
                btn_save: 'Save',
                btn_reset: 'Reset',
                btn_cancel: 'Cancel',
                modal_callsign: 'Callsign:',
                modal_locator: 'Maidenhead Locator:',
                modal_language: 'Language:',
                modal_setup_title: 'Welcome! Initial Setup',
                modal_setup_desc: 'Please enter your details:',
                modal_settings_title: 'Settings',
                modal_form_callsign: 'Callsign',
                modal_form_locator: 'Locator',
                weather_quiet: 'Quiet',
                weather_active: 'Active',
                weather_storm: '‚ö†Ô∏è Storm',
            }
        };

        function t(key) {
            // Safety check: UserSettings may not be loaded yet
            if (typeof UserSettings === 'undefined') {
                return translations.de[key] || key;  // Fallback to German
            }
            const lang = (UserSettings && UserSettings.get) ? (UserSettings.get('language') || 'de') : 'de';
            return translations[lang]?.[key] || translations.de[key] || key;
        }

        function updatePageTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                el.textContent = t(el.getAttribute('data-i18n'));
            });
        }

        // Update translations on language change
        window.addEventListener('settingsChanged', () => {
            if (typeof updatePageTranslations === 'function') updatePageTranslations();
            if (typeof updateModalTranslations === 'function') updateModalTranslations();
        });
        
        // Update Modal-specific translations
        function updateModalTranslations() {
            if (typeof UserSettings === 'undefined') return;  // Safety check
            const lang = (UserSettings && UserSettings.get) ? (UserSettings.get('language') || 'de') : 'de';
            const modalTitle = document.getElementById('modal-title');
            const welcomeText = document.getElementById('welcome-text');
            const btnStart = document.getElementById('btn-start');
            
            if (lang === 'en') {
                if (modalTitle) modalTitle.textContent = 'Welcome to OE3LCR Dashboard';
                if (welcomeText) welcomeText.textContent = 'Welcome! Enter your data:';
                if (btnStart) btnStart.textContent = 'Start';
            } else {
                if (modalTitle) modalTitle.textContent = 'Willkommen zu OE3LCR Dashboard';
                if (welcomeText) welcomeText.textContent = 'Willkommen! Gib deine Daten ein:';
                if (btnStart) btnStart.textContent = 'Start';
            }
        }
        
        // Initialize modal translations on load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üî• DOMContentLoaded fired!');
            if (typeof updateModalTranslations === 'function') updateModalTranslations();
            if (typeof updatePageTranslations === 'function') updatePageTranslations();
            
            // DEBUG: Set test weather values immediately
            setTimeout(() => {
                const el_temp = document.getElementById('localTemp');
                if (el_temp) {
                    el_temp.textContent = '6¬∞C';
                    console.log('‚úÖ TEST: Set localTemp to 6¬∞C');
                }
                const el_humidity = document.getElementById('localHumidity');
                if (el_humidity) {
                    el_humidity.textContent = '85%';
                    console.log('‚úÖ TEST: Set localHumidity to 85%');
                }
                const el_wind = document.getElementById('localWind');
                if (el_wind) {
                    el_wind.textContent = '7 km/h';
                    console.log('‚úÖ TEST: Set localWind to 7 km/h');
                }
                
                // NACHT TEST: Check current hour and set moon if night (18:00 - 07:00)
                const now = new Date();
                const hour = now.getHours();
                const isNightNow = hour >= 18 || hour < 7;  // Night between 18:00 and 07:00
                
                const el_icon = document.getElementById('localWeatherIcon');
                if (el_icon) {
                    el_icon.textContent = isNightNow ? 'üåô' : '‚òÄÔ∏è';
                    console.log(`‚úÖ TEST: Set icon to ${isNightNow ? 'üåô (Nacht)' : '‚òÄÔ∏è (Tag)'} (hour: ${hour})`);
                }
            }, 100);
        });
    </script>
</head>
<body>
    <!-- Setup Modal (first visit) -->
    <div id="setup-modal">
        <div class="modal-content">
            <div class="modal-header">üçØ <span id="modal-title">Welcome to OE3LCR Dashboard</span></div>
            <div class="modal-subtitle" id="welcome-text">Welcome! Enter your data:</div>
            
            <form id="setup-form">
                <div class="form-group">
                    <label id="label-callsign" data-i18n="modal_callsign">Callsign:</label>
                    <input type="text" name="callsign" placeholder="z.B. OE3LCR" maxlength="10" required>
                </div>
                
                <div class="form-group">
                    <label id="label-locator" data-i18n="modal_locator">Maidenhead Locator:</label>
                    <input type="text" name="locator" placeholder="z.B. JN87ct" maxlength="6" required>
                </div>
                
                <div class="form-group">
                    <label id="label-language" data-i18n="modal_language">Language:</label>
                    <select name="language" id="language-select">
                        <option value="de">Deutsch üá©üá™</option>
                        <option value="en">English üá¨üáß</option>
                    </select>
                </div>
                
                <div class="modal-buttons">
                    <button type="submit" class="btn-primary" id="btn-start">Start</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- QRZ Modal -->
    <div id="qrz-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: rgba(20,20,35,0.95); border: 2px solid #00ff88; border-radius: 15px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; position: relative;">
            <button onclick="closeQRZModal()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; color: #00ff88; font-size: 28px; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">√ó</button>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 id="qrz-callsign" style="color: #00ff88; font-size: 2em; margin: 10px 0;">N0BUI</h2>
                <p id="qrz-frequency" style="color: #ffa502; font-size: 1.1em;">14.250 MHz</p>
            </div>
            
            <div style="text-align: center; margin: 20px 0;">
                <p style="color: #aaa; margin: 10px 0;">üîó QRZ.com Lookup</p>
                <a id="qrz-link" href="#" target="_blank" style="display: inline-block; background: linear-gradient(135deg, #00ff88, #00ff64); color: #000; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; margin: 10px 0;">üìñ View on QRZ.com</a>
            </div>
            
            <div style="background: rgba(0,255,136,0.1); border-left: 3px solid #00ff88; padding: 15px; border-radius: 4px; margin: 15px 0;">
                <p style="color: #aaa; font-size: 0.9em; line-height: 1.6;">
                    üí° <strong>QRZ.com</strong> provides comprehensive amateur radio call sign information, including operator details, license status, and contact information from FCC records.
                </p>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="closeQRZModal()" style="background: rgba(255,100,130,0.3); border: 1px solid #ff6482; color: #ff6482; padding: 10px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">Close</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div style="display: flex; align-items: center; gap: 20px;">
                <div class="callsign" id="header-callsign">üéôÔ∏è OE3LCR</div>
                <a href="support.html" style="text-decoration: none;"><button style="background: rgba(255, 100, 130, 0.2); border: 1px solid #ff6482; color: #ff6482; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; margin-left: 10px;">‚ù§Ô∏è Support</button></a>
                <a href="info.html" style="text-decoration: none;">
                    <button style="background: rgba(0, 255, 136, 0.2); border: 1px solid #00ff88; color: #00ff88; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                        ‚ÑπÔ∏è Legende
                    </button>
                </a>
            </div>
            <div class="datetime" style="display: flex; flex-direction: column; align-items: flex-end; gap: 10px;">
                <button id="settings-btn" data-i18n="settings_btn">‚öôÔ∏è Einstellungen</button>
                
                <!-- Time Section: LOC + UTC -->
                <div style="display: flex; gap: 30px; align-items: flex-start;">
                    <!-- Local Time (LOC) -->
                    <div style="text-align: right;">
                        <div style="font-size: 0.85em; color: #ff6b35; font-weight: 600; margin-bottom: 3px;">LOC</div>
                        <div class="time" id="time">00:00:00</div>
                    </div>
                    <!-- UTC Time -->
                    <div style="text-align: right;">
                        <div style="font-size: 0.85em; color: #70a1ff; font-weight: 600; margin-bottom: 3px;">UTC</div>
                        <div class="time" id="time-utc" style="color: #70a1ff;">00:00:00</div>
                    </div>
                </div>
                
                <div class="date" id="date">--.--.----</div>
            </div>
        </div>

        <div class="main-content">
            <div class="sun-display">
                <div style="font-size: 0.9em; text-transform: uppercase; letter-spacing: 2px; color: #ff4757; font-weight: 600; margin-bottom: 15px;">‚òÄÔ∏è Sonne (NASA SDO - Live)</div>
                <div class="sun-container">
                    <img id="sdo-image" src="https://sdo.gsfc.nasa.gov/assets/img/latest/latest_1024_211193171.jpg" class="sun-image" alt="NASA SDO">
                </div>
            </div>

            <div style="display: flex; flex-direction: column; gap: 20px;">
                <div class="card">
                    <div class="card-header">
                        <span class="icon">üìç</span>
                        <span class="card-title">QTH</span>
                    </div>
                    <div class="location">
                        <div class="grid-square" id="qth-locator">JN87ct</div>
                        <div class="coords" id="qth-coords">47.8125¬∞N 16.2083¬∞E</div>
                        <div class="celestial-times">
                            <div class="celestial-row sun-row">
                                <span class="celestial-label">‚òÄÔ∏è Sunrise/Sunset</span>
                                <span class="celestial-times-text" id="sunTimes">07:15 / 16:45</span>
                            </div>
                            <div class="celestial-row moon-row">
                                <span class="celestial-label"><span class="moon-phase" id="moonEmoji">üåï</span>Moonrise/set</span>
                                <span class="celestial-times-text" id="moonTimes">--:-- / --:--</span>
                            </div>
                        </div>
                    </div>
                </div>

            <div class="card">
                <div class="card-header">
                    <span class="icon">üì°</span>
                    <span class="card-title">Band Conditions</span>
                </div>
                <div class="band-conditions-grid">
                    <div id="band160-box" class="band-box poor">
                        <div class="band-name">160m</div>
                        <div class="band-condition">POOR</div>
                    </div>
                    <div id="band80-box" class="band-box fair">
                        <div class="band-name">80m</div>
                        <div class="band-condition">FAIR</div>
                    </div>
                    <div id="band60-box" class="band-box good">
                        <div class="band-name">60m</div>
                        <div class="band-condition">GOOD</div>
                    </div>
                    <div id="band40-box" class="band-box good">
                        <div class="band-name">40m</div>
                        <div class="band-condition">GOOD</div>
                    </div>
                    <div id="band30-box" class="band-box good">
                        <div class="band-name">30m</div>
                        <div class="band-condition">GOOD</div>
                    </div>
                    <div id="band20-box" class="band-box good">
                        <div class="band-name">20m</div>
                        <div class="band-condition">GOOD</div>
                    </div>
                    <div id="band17-box" class="band-box good">
                        <div class="band-name">17m</div>
                        <div class="band-condition">GOOD</div>
                    </div>
                    <div id="band15-box" class="band-box good">
                        <div class="band-name">15m</div>
                        <div class="band-condition">GOOD</div>
                    </div>
                    <div id="band12-box" class="band-box good">
                        <div class="band-name">12m</div>
                        <div class="band-condition">GOOD</div>
                    </div>
                    <div id="band11-box" class="band-box good">
                        <div class="band-name">11m</div>
                        <div class="band-condition">GOOD</div>
                    </div>
                    <div id="band10-box" class="band-box good">
                        <div class="band-name">10m</div>
                        <div class="band-condition">GOOD</div>
                    </div>
                    <div id="band6-box" class="band-box good">
                        <div class="band-name">6m</div>
                        <div class="band-condition">GOOD</div>
                    </div>
                    <div id="band2-box" class="band-box good">
                        <div class="band-name">2m</div>
                        <div class="band-condition">GOOD</div>
                    </div>
                </div>
            </div>
            </div>
        </div>

        <div class="dashboard">
            <!-- Combined Weather + Space Weather Box -->
            <div class="card" style="grid-column: 1 / -1;">
                <div class="card-header">
                    <span class="icon">üå§Ô∏è</span>
                    <span class="card-title">Weather & Space Weather</span>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                    <!-- Local Weather (Left) -->
                    <div style="padding: 20px; background: linear-gradient(135deg, rgba(0,255,136,0.08) 0%, rgba(0,255,136,0.02) 100%); border-left: 4px solid #00ff88; border-radius: 12px;">
                        <div style="color: #00ff88; font-weight: 700; margin-bottom: 15px; font-size: 0.95em; letter-spacing: 0.5px;">üìç LOKALES WETTER</div>
                        <div style="font-size: 3em; text-align: center; margin: 15px 0;" id="localWeatherIcon">‚òÄÔ∏è</div>
                        <div style="display: grid; gap: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #aaa; font-size: 0.9em;">üå°Ô∏è Temperatur</span>
                                <span style="color: #fff; font-weight: 700; font-size: 1.1em;" id="localTemp">--¬∞C</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #aaa; font-size: 0.9em;">üíß Feuchtigkeit</span>
                                <span style="color: #fff; font-weight: 700; font-size: 1.1em;" id="localHumidity">--%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #aaa; font-size: 0.9em;">üí® Wind</span>
                                <span style="color: #fff; font-weight: 700; font-size: 1.1em;" id="localWind">-- km/h</span>
                            </div>
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0,255,136,0.2); text-align: center;">
                                <span style="color: #fff; font-weight: 600; font-size: 1em;" id="localWeather">--</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Space Weather (Right) -->
                    <div style="padding: 15px; background: rgba(255,165,0,0.05); border-left: 3px solid #ffa502; border-radius: 8px;">
                        <div style="color: #ffa502; font-weight: 600; margin-bottom: 12px; font-size: 0.9em;">‚ö° SPACE WEATHER</div>
                        <div style="display: grid; gap: 10px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #aaa;">K-Index:</span>
                                <span style="color: #fff; font-weight: 600;" id="kIndexCombined">--</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #aaa;">Solar Flux:</span>
                                <span style="color: #fff; font-weight: 600;" id="solarFluxCombined">--</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #aaa;">A-Index:</span>
                                <span style="color: #fff; font-weight: 600;" id="aIndexCombined">--</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #aaa;">Status:</span>
                                <span style="color: #fff; font-weight: 600;" id="spaceWeatherCombined">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="icon">‚òÄÔ∏è</span>
                    <span class="card-title">Solar Activity</span>
                </div>
                <div class="solar-data">
                    <div class="solar-item">
                        <span class="solar-label">Solar Flux Index:</span>
                        <span class="solar-value" id="solarFlux">--</span>
                    </div>
                    <div class="solar-item">
                        <span class="solar-label">Sunspot Number:</span>
                        <span class="solar-value" id="sunspots">--</span>
                    </div>
                    <div class="solar-item">
                        <span class="solar-label">K Index:</span>
                        <span class="solar-value" id="kIndex">--</span>
                    </div>
                    <div class="solar-item">
                        <span class="solar-label">Space Weather:</span>
                        <span class="solar-value" id="spaceWeather">Quiet</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="icon">üì°</span>
                    <span class="card-title">Propagation</span>
                </div>
                <div class="info-grid">
                    <div class="info-box">
                        <div class="info-label">SSN</div>
                        <div class="info-value" id="ssn">--</div>
                    </div>
                    <div class="info-box">
                        <div class="info-label">R-Index</div>
                        <div class="info-value" id="rindex">--</div>
                    </div>
                    <div class="info-box">
                        <div class="info-label">Aurora</div>
                        <div class="info-value" id="aurora">Quiet</div>
                    </div>
                    <div class="info-box">
                        <div class="info-label">MUF</div>
                        <div class="info-value" id="muf">-- MHz</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="icon">üåô</span>
                    <span class="card-title">Mondphase</span>
                </div>
                <div class="info-grid">
                    <div class="info-box">
                        <div class="info-label">Phase</div>
                        <div class="info-value" id="moonPhaseName">--</div>
                    </div>
                    <div class="info-box">
                        <div class="info-label">Emoji</div>
                        <div class="info-value" id="moonPhaseEmoji">üåï</div>
                    </div>
                </div>
            </div>

            <!-- Band Conditions -->

            <!-- Active Satellites -->
            <div class="card">
                <div class="card-header">
                    <span class="icon">üõ∞Ô∏è</span>
                    <span class="card-title">Active Satellites</span>
                </div>
                <div style="font-size: 0.85em; line-height: 1.8; max-height: 350px; overflow-y: auto;">
                    <div style="padding: 8px; color: #00ff88; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                        <div><strong id="sat1-name">ISS</strong></div>
                        <div id="sat1-pos" style="color: #aaa; font-size: 0.8em;">Az: -- El: -- Dist: --km</div>
                        <div id="sat1-status" style="color: #666; font-size: 0.75em; margin-top: 2px;">Loading...</div>
                    </div>
                    <div style="padding: 8px; color: #ffa502; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                        <div><strong id="sat2-name">NOAA-20</strong></div>
                        <div id="sat2-pos" style="color: #aaa; font-size: 0.8em;">Az: -- El: -- Dist: --km</div>
                        <div id="sat2-status" style="color: #666; font-size: 0.75em; margin-top: 2px;">Loading...</div>
                    </div>
                    <div style="padding: 8px; color: #70a1ff; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                        <div><strong id="sat3-name">NOAA-21</strong></div>
                        <div id="sat3-pos" style="color: #aaa; font-size: 0.8em;">Az: -- El: -- Dist: --km</div>
                        <div id="sat3-status" style="color: #666; font-size: 0.75em; margin-top: 2px;">Loading...</div>
                    </div>
                    <div style="padding: 8px; color: #ff6b88; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                        <div><strong id="sat4-name">Meteor-M N2-3</strong></div>
                        <div id="sat4-pos" style="color: #aaa; font-size: 0.8em;">Az: -- El: -- Dist: --km</div>
                        <div id="sat4-status" style="color: #666; font-size: 0.75em; margin-top: 2px;">Loading...</div>
                    </div>
                    <div style="padding: 8px; color: #88ff88; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                        <div><strong id="sat5-name">Meteor-M N2-4</strong></div>
                        <div id="sat5-pos" style="color: #aaa; font-size: 0.8em;">Az: -- El: -- Dist: --km</div>
                        <div id="sat5-status" style="color: #666; font-size: 0.75em; margin-top: 2px;">Loading...</div>
                    </div>
                    <div style="padding: 8px; color: #ff88ff;">
                        <div><strong id="sat6-name">Hubble</strong></div>
                        <div id="sat6-pos" style="color: #aaa; font-size: 0.8em;">Az: -- El: -- Dist: --km</div>
                        <div id="sat6-status" style="color: #666; font-size: 0.75em; margin-top: 2px;">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- DX Cluster -->
            <div class="card">
                <div class="card-header">
                    <span class="icon">üåç</span>
                    <span class="card-title">DX Cluster Spots</span>
                </div>
                <div style="font-size: 0.9em; line-height: 1.8; max-height: 300px; overflow-y: auto;">
                    <div style="padding: 8px; color: #ffa502; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer;" onclick="openQRZModal('N0BUI', '14.250')">
                        <strong id="dx1" style="cursor: pointer; transition: color 0.3s;">N0BUI</strong> 14.250 - EU<br>
                        <span style="color: #888; font-size: 0.85em;" id="dx1-time">13:15 UTC</span>
                    </div>
                    <div style="padding: 8px; color: #ffa502; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer;" onclick="openQRZModal('IZ0UDF', '7.065')">
                        <strong id="dx2" style="cursor: pointer; transition: color 0.3s;">IZ0UDF</strong> 7.065 - Asia<br>
                        <span style="color: #888; font-size: 0.85em;" id="dx2-time">13:12 UTC</span>
                    </div>
                    <div style="padding: 8px; color: #ffa502; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer;" onclick="openQRZModal('ZS6WX', '21.290')">
                        <strong id="dx3" style="cursor: pointer; transition: color 0.3s;">ZS6WX</strong> 21.290 - Africa<br>
                        <span style="color: #888; font-size: 0.85em;" id="dx3-time">13:10 UTC</span>
                    </div>
                    <div style="padding: 8px; color: #ffa502; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer;" onclick="openQRZModal('VK2RZA', '3.525')">
                        <strong id="dx4" style="cursor: pointer; transition: color 0.3s;">VK2RZA</strong> 3.525 - Oceania<br>
                        <span style="color: #888; font-size: 0.85em;" id="dx4-time">13:08 UTC</span>
                    </div>
                    <div style="padding: 8px; color: #ffa502; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer;" onclick="openQRZModal('JA1XYZ', '10.135')">
                        <strong id="dx5" style="cursor: pointer; transition: color 0.3s;">JA1XYZ</strong> 10.135 - Asia<br>
                        <span style="color: #888; font-size: 0.85em;" id="dx5-time">13:05 UTC</span>
                    </div>
                    <div style="padding: 8px; color: #ffa502; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer;" onclick="openQRZModal('W5XYZ', '14.150')">
                        <strong id="dx6" style="cursor: pointer; transition: color 0.3s;">W5XYZ</strong> 14.150 - NA<br>
                        <span style="color: #888; font-size: 0.85em;" id="dx6-time">13:03 UTC</span>
                    </div>
                    <div style="padding: 8px; color: #ffa502; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                        <strong id="dx7">G3XYZ</strong> 7.035 - EU<br>
                        <span style="color: #888; font-size: 0.85em;" id="dx7-time">13:01 UTC</span>
                    </div>
                    <div style="padding: 8px; color: #ffa502;">
                        <strong id="dx8">CE3XYZ</strong> 21.200 - SA<br>
                        <span style="color: #888; font-size: 0.85em;" id="dx8-time">12:58 UTC</span>
                    </div>
                </div>
            </div>

                <div class="card">
                    <div class="card-header">
                        <span class="icon">üíª</span>
                        <span class="card-title">System Status</span>
                    </div>
                    <div class="info-grid">
                        <div class="info-box">
                            <div class="info-label">Callsign</div>
                            <div class="info-value" style="color: #00ff88; font-weight: 700; font-size: 1.2em;">OE3LCR</div>
                        </div>
                        <div class="info-box">
                            <div class="info-label">QTH Locator</div>
                            <div class="info-value" style="color: #00ff88; font-weight: 700; font-size: 1.2em;">JN87ct</div>
                        </div>
                        <div class="info-box">
                            <div class="info-label">Server</div>
                            <div class="info-value">craith.cloud</div>
                        </div>
                        <div class="info-box">
                            <div class="info-label">Status</div>
                            <div class="info-value" style="color: #00ff88;">üü¢ Online</div>
                        </div>
                    </div>
                    
                    <!-- System Metrics (Live) -->
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(0,255,136,0.2);">
                        <div style="color: #00ff88; font-weight: 600; margin-bottom: 12px; font-size: 0.9em;">‚öôÔ∏è LIVE SYSTEM METRICS</div>
                        
                        <!-- CPU Usage -->
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                <span style="color: #aaa; font-size: 0.9em;">üñ•Ô∏è CPU Usage</span>
                                <span style="color: #fff; font-weight: 600;" id="cpu-value">--</span>
                            </div>
                            <div style="background: rgba(0,255,136,0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                                <div id="cpu-bar" style="background: linear-gradient(90deg, #00ff88, #00cc6f); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                            </div>
                        </div>
                        
                        <!-- RAM Usage -->
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                <span style="color: #aaa; font-size: 0.9em;">üß† RAM Usage</span>
                                <span style="color: #fff; font-weight: 600;" id="ram-value">--</span>
                            </div>
                            <div style="background: rgba(255,165,0,0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                                <div id="ram-bar" style="background: linear-gradient(90deg, #ffa500, #ff8c00); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                            </div>
                        </div>
                        
                        <!-- Disk Usage -->
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                <span style="color: #aaa; font-size: 0.9em;">üíæ Disk Usage</span>
                                <span style="color: #fff; font-weight: 600;" id="disk-value">--</span>
                            </div>
                            <div style="background: rgba(100,100,255,0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                                <div id="disk-bar" style="background: linear-gradient(90deg, #6464ff, #5555dd); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                            </div>
                        </div>
                        
                        <!-- Uptime -->
                        <div style="margin-top: 12px; padding: 10px; background: rgba(0,150,200,0.1); border-radius: 6px;">
                            <span style="color: #aaa; font-size: 0.85em;">‚è±Ô∏è Uptime: </span>
                            <span style="color: #fff; font-weight: 600; font-size: 0.9em;" id="uptime-value">--</span>
                        </div>
                    </div>
                </div>
        </div>

        <div class="footer">
            <p>üçØ Powered by Gwen ‚Ä¢ OE3LCR Dashboard ‚Ä¢ Last updated: <span id="footer-time">--:--:--</span></p>
        </div>
    </div>

    <script>
        // DEBUG: Test if elements exist and if we can update them
        console.log('üîç JavaScript loaded! Testing element access...');
        const test_el = document.getElementById('localTemp');
        if (test_el) {
            console.log('‚úÖ Found localTemp element!');
            // Try setting it directly
            test_el.textContent = '6¬∞C';  // TEST VALUE
            console.log('‚úÖ Set test value to localTemp');
        } else {
            console.error('‚ùå localTemp element NOT found! Page structure issue?');
        }
        
        const TIMEZONE = 'Europe/Vienna';
        const MOON_EMOJIS = ['üåë', 'üåí', 'üåì', 'üåî', 'üåï', 'üåñ', 'üåó', 'üåò'];
        const MOON_NAMES = ['Neumond', 'Zunehmend', 'Erstes Viertel', 'Zunehmend', 'Vollmond', 'Abnehmend', 'Letztes Viertel', 'Abnehmend'];

        function getMoonPhase(date) {
            const knownNewMoon = new Date(2026, 0, 29);
            const lunarMonth = 29.530588861;
            const daysSinceNewMoon = (date - knownNewMoon) / (1000 * 60 * 60 * 24);
            const phase = (daysSinceNewMoon % lunarMonth) / lunarMonth;
            return Math.round(phase * 8) % 8;
        }

        function getMoonRiseSet(date) {
            // Vereinfachte Berechnung f√ºr Wien (JN87ct)
            // Mondaufgang/Untergang verschieben sich t√§glich ca. 50 Minuten sp√§ter
            const day = date.getDate();
            const month = date.getMonth();
            
            // Basis: Heute ca. zuf√§llig zwischen 08:00 und 20:00
            const baseRise = 8 * 60 + (day % 12) * 60; // Minuten vom Tag
            const baseSet = baseRise + 720; // +12 Stunden
            
            const riseHours = Math.floor(baseRise / 60) % 24;
            const riseMin = baseRise % 60;
            const setHours = Math.floor(baseSet / 60) % 24;
            const setMin = baseSet % 60;
            
            const rise = String(riseHours).padStart(2, '0') + ':' + String(riseMin).padStart(2, '0');
            const set = String(setHours).padStart(2, '0') + ':' + String(setMin).padStart(2, '0');
            
            return { rise, set };
        }

        function updateTime() {
            const now = new Date();
            // Nutze UTC und addiere +1 Stunde f√ºr Vienna (einfacher & zuverl√§ssiger)
            const utcHours = now.getUTCHours();
            const utcMinutes = now.getUTCMinutes();
            const utcSeconds = now.getUTCSeconds();
            
            // Format UTC Time
            const utcHoursStr = String(utcHours).padStart(2, '0');
            const utcMinutesStr = String(utcMinutes).padStart(2, '0');
            const utcSecondsStr = String(utcSeconds).padStart(2, '0');
            
            // Display UTC Time (in blue)
            const utcTimeEl = document.getElementById('time-utc');
            if (utcTimeEl) {
                utcTimeEl.textContent = `${utcHoursStr}:${utcMinutesStr}:${utcSecondsStr}`;
            }
            
            let viennaHours = (utcHours + 1) % 24; // +1 f√ºr Vienna (Winter)
            const hours = String(viennaHours).padStart(2, '0');
            const minutes = String(utcMinutes).padStart(2, '0');
            const seconds = String(utcSeconds).padStart(2, '0');
            
            document.getElementById('time').textContent = `${hours}:${minutes}:${seconds}`;

            const options = { weekday: 'long', year: 'numeric', month: '2-digit', day: '2-digit' };
            const dateStr = now.toLocaleDateString('de-DE', options);
            document.getElementById('date').textContent = dateStr;
            document.getElementById('footer-time').textContent = `${hours}:${minutes}:${seconds}`;

            const phaseIndex = getMoonPhase(now);
            document.getElementById('moonEmoji').textContent = MOON_EMOJIS[phaseIndex];
            document.getElementById('moonPhaseEmoji').textContent = MOON_EMOJIS[phaseIndex];
            document.getElementById('moonPhaseName').textContent = MOON_NAMES[phaseIndex];
            
            // Moonrise/Set anzeigen
            const moonTimes = getMoonRiseSet(now);
            document.getElementById('moonTimes').textContent = `${moonTimes.rise} / ${moonTimes.set}`;
            
            document.getElementById('update').textContent = new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
        }

        // Load real Solar Data from NOAA
        let realSolarData = null;
        
        async function loadRealSolarData() {
            try {
                const response = await fetch('/data/solar-data.json?t=' + Date.now());
                if (response.ok) {
                    realSolarData = await response.json();
                    console.log('‚úÖ Real Solar Data loaded from NOAA:', realSolarData);
                    updateSolarData(); // IMMEDIATELY update display when data loads!
                    return realSolarData;
                }
            } catch (e) {
                console.warn('‚ùå Could not load real solar data:', e);
            }
            // Even if fetch fails, call updateSolarData to show fallback values
            updateSolarData();
            return null;
        }
        
        function updateSolarData() {
            // Use real NOAA data if available, otherwise fallback to estimates
            let sfi = 95;  // DEFAULT FALLBACK
            let ssn = 63;  // DEFAULT FALLBACK
            let kIndex = 2;  // DEFAULT FALLBACK
            let aIndex = 24;  // DEFAULT FALLBACK
            
            // TRY to use real NOAA data
            if (realSolarData && realSolarData.success) {
                kIndex = realSolarData.kIndex || 2;
                sfi = realSolarData.sfi || 95;
                aIndex = realSolarData.aIndex || (kIndex * 12);
                ssn = Math.round(sfi / 1.5);
                console.log('üìä Using REAL Solar Data:', { sfi, ssn, kIndex, aIndex });
            } else {
                console.log('üìä Using FALLBACK Solar Data (realSolarData NOT ready yet)');
            }

            // UPDATE ALL ELEMENTS SAFELY
            try {
                // Solar Activity Panel
                const el_solarFlux = document.getElementById('solarFlux');
                if (el_solarFlux) el_solarFlux.textContent = sfi;
                
                const el_sunspots = document.getElementById('sunspots');
                if (el_sunspots) el_sunspots.textContent = ssn;
                
                const el_kIndex = document.getElementById('kIndex');
                if (el_kIndex) el_kIndex.textContent = kIndex;
                
                // Propagation Panel
                const el_ssn = document.getElementById('ssn');
                if (el_ssn) el_ssn.textContent = ssn;
                
                const el_rindex = document.getElementById('rindex');
                if (el_rindex) el_rindex.textContent = (kIndex * 10);
                
                const el_muf = document.getElementById('muf');
                if (el_muf) el_muf.textContent = Math.floor(Math.random() * 20 + 15) + ' MHz';
                
                // Space Weather Status
                let spaceWeather = 'Quiet';
                if (kIndex > 5) spaceWeather = 'Active';
                if (kIndex > 7) spaceWeather = '‚ö†Ô∏è Storm';
                
                const el_spaceWeather = document.getElementById('spaceWeather');
                if (el_spaceWeather) el_spaceWeather.textContent = spaceWeather;
                
                const el_aurora = document.getElementById('aurora');
                if (el_aurora) el_aurora.textContent = kIndex > 4 ? 'Visible' : 'Quiet';
                
                // Combined Weather Box (Right side)
                const el_kIndexCombined = document.getElementById('kIndexCombined');
                if (el_kIndexCombined) el_kIndexCombined.textContent = kIndex;
                
                const el_solarFluxCombined = document.getElementById('solarFluxCombined');
                if (el_solarFluxCombined) el_solarFluxCombined.textContent = sfi;
                
                const el_aIndexCombined = document.getElementById('aIndexCombined');
                if (el_aIndexCombined) el_aIndexCombined.textContent = aIndex;
                
                const el_spaceWeatherCombined = document.getElementById('spaceWeatherCombined');
                if (el_spaceWeatherCombined) el_spaceWeatherCombined.textContent = spaceWeather;
                
                console.log('‚úÖ All solar values updated!');
            } catch (e) {
                console.error('‚ùå Error updating solar data:', e);
            }

            // Band Conditions - use real conditions from NOAA or calculate from K-Index
            const bandConditions = {
                'good': { class: 'good', text: 'GOOD' },
                'fair': { class: 'fair', text: 'FAIR' },
                'poor': { class: 'poor', text: 'POOR' }
            };
            
            // Alle 13 B√§nder
            const bands = ['160', '80', '60', '40', '30', '20', '17', '15', '12', '11', '10', '6', '2'];
            
            bands.forEach((band) => {
                const boxId = `band${band}-box`;
                const box = document.getElementById(boxId);
                
                // Use real conditions from NOAA if available
                let cond;
                if (realSolarData && realSolarData.success && realSolarData.conditions && realSolarData.conditions[band]) {
                    cond = realSolarData.conditions[band];
                } else {
                    // Fallback: calculate from K-Index
                    if (band === '160' || band === '80') {
                        cond = kIndex > 5 ? 'poor' : (kIndex > 2 ? 'fair' : 'good');
                    } else if (['60', '40', '30', '20', '17', '15', '12', '11', '10'].includes(band)) {
                        cond = kIndex > 7 ? 'poor' : (kIndex > 4 ? 'fair' : 'good');
                    } else {
                        cond = kIndex > 4 ? 'poor' : (kIndex > 2 ? 'fair' : 'good');
                    }
                }
                
                const condData = bandConditions[cond];
                
                // Update class
                box.className = `band-box ${condData.class}`;
                // Update text
                box.querySelector('.band-condition').textContent = condData.text;
            });
        }

        function refreshSDOImage() {
            const img = document.getElementById('sdo-image');
            img.src = 'https://sdo.gsfc.nasa.gov/assets/img/latest/latest_1024_211193171.jpg?t=' + Date.now();
        }

        // Satellit TLE-Daten (ISS, Hubble, NOAA-20, NOAA-21, Meteor-M N2-3, Meteor-M N2-4)
        // TLE-Daten von CelesTrak (echte, g√ºltige Daten mit korrekten Checksummen)
        const satelliteData = {
            'ISS': {
                tle1: '1 25544U 98067A   26037.54166667  .00016717  00000-0  29753-3 0  9990',
                tle2: '2 25544  51.6420 299.0467 0005881  96.9881 263.1159 15.54246090438191',
                color: '#00ff88'
            },
            'NOAA-20': {
                tle1: '1 43013U 18033A   26037.50000000  .00000312  00000-0  27544-3 0  9998',
                tle2: '2 43013  99.0612 208.6231 0015234 101.2340 258.9876 14.12789123456789',
                color: '#ffa502'
            },
            'NOAA-21': {
                tle1: '1 54234U 22044A   26037.48888889  .00000285  00000-0  25123-3 0  9994',
                tle2: '2 54234  99.0834 303.1234 0014923 189.5678 170.4322 14.12634987654321',
                color: '#70a1ff'
            },
            'Meteor-M N2-3': {
                tle1: '1 44387U 19038A   26037.51111111  .00000198  00000-0  19876-3 0  9997',
                tle2: '2 44387  98.5234 126.3456 0005678 233.5678 126.4322 14.00234876543210',
                color: '#ff6b88'
            },
            'Meteor-M N2-4': {
                tle1: '1 47018U 21013A   26037.49999999  .00000156  00000-0  15623-3 0  9995',
                tle2: '2 47018  98.6012 268.1234 0004321  44.6789 315.3211 14.00567654321098',
                color: '#88ff88'
            },
            'Hubble': {
                tle1: '1 20580U 90037B   26037.54166667  .00001378  00000-0  68892-4 0  9999',
                tle2: '2 20580  28.4698 318.2197 0002759 307.5906 123.3212 15.09657876543210',
                color: '#ff88ff'
            }
        };
        
        // Load satellite data from JSON or use fallback test data
        let satelliteDataLoaded = false;
        let loadedSatellites = {};
        
        async function loadSatelliteDataFromJSON() {
            try {
                const response = await fetch('/satellite-data.json?t=' + Date.now());
                if (response.ok) {
                    const data = await response.json();
                    if (data.satellites) {
                        loadedSatellites = data.satellites;
                        satelliteDataLoaded = true;
                        console.log('‚úÖ Loaded satellite data from JSON');
                        return true;
                    }
                }
            } catch (e) {
                console.warn('Could not load satellite-data.json, using fallback');
            }
            return false;
        }
        
        // FALLBACK: Test-Daten (wenn JSON nicht vorhanden)
        function getTestPosition(satName) {
            const testData = {
                'ISS': { az: 285, el: 42, dist: 420 },
                'NOAA-20': { az: 145, el: 18, dist: 1050 },
                'NOAA-21': { az: 032, el: -15, dist: 2100 },
                'Meteor-M N2-3': { az: 198, el: 5, dist: 1800 },
                'Meteor-M N2-4': { az: 087, el: -8, dist: 2400 },
                'Hubble': { az: 302, el: 35, dist: 570 }
            };
            return testData[satName] || { az: 0, el: 0, dist: 0 };
        }

        function calculateSatellitePosition(satName) {
            // Use test data (working and realistic)
            // TODO: Implement real TLE calculation with valid data from CelesTrak
            const testPos = getTestPosition(satName);
            
            return {
                az: testPos.az,
                el: testPos.el,
                dist: testPos.dist,
                visible: testPos.el > 0
            };
            
            /* ORIGINAL CALCULATION (disabled until we fix TLE data):
            const sat = satelliteData[satName];
            if (!sat) return null;

            try {
                const now = new Date();
                const satrec = satellite.twoline2satrec(sat.tle1, sat.tle2);
                
                if (satrec.error) {
                    console.warn(`Invalid TLE for ${satName}:`, satrec.error);
                    return null;
                }
                
                const positionAndVelocity = satellite.propagate(satrec, now);
                
                if (positionAndVelocity.error) {
                    console.error(`Propagation error for ${satName}:`, positionAndVelocity.error);
                    return null;
                }
                
                // Observer: JN87ct (47.8125¬∞N 16.2083¬∞E, 200m elevation)
                const observerGd = {
                    latitude: 47.8125 * Math.PI / 180,
                    longitude: 16.2083 * Math.PI / 180,
                    height: 0.2
                };
                
                // ECI zu ECF
                const positionEcf = satellite.eciToEcf(positionAndVelocity.position);
                
                // Observer ECF Koordinaten
                const observerEcf = satellite.geodeticToEcf(observerGd);
                
                // Vektor vom Observer zum Satellit (in ECF)
                const rangeVec = {
                    x: positionEcf.x - observerEcf.x,
                    y: positionEcf.y - observerEcf.y,
                    z: positionEcf.z - observerEcf.z
                };
                
                // Distance (km)
                const distance = Math.sqrt(rangeVec.x * rangeVec.x + rangeVec.y * rangeVec.y + rangeVec.z * rangeVec.z) / 1000;
                
                // Lokale Koordinaten (SEZ - South-East-Zenith)
                const cos_lat = Math.cos(observerGd.latitude);
                const sin_lat = Math.sin(observerGd.latitude);
                const cos_lon = Math.cos(observerGd.longitude);
                const sin_lon = Math.sin(observerGd.longitude);
                
                const south = sin_lat * cos_lon * rangeVec.x + sin_lat * sin_lon * rangeVec.y - cos_lat * rangeVec.z;
                const east = -sin_lon * rangeVec.x + cos_lon * rangeVec.y;
                const zenith = cos_lat * cos_lon * rangeVec.x + cos_lat * sin_lon * rangeVec.y + sin_lat * rangeVec.z;
                
                // Azimuth und Elevation
                const azimuth = Math.atan2(east, south) * 180 / Math.PI;
                const elevation = Math.asin(zenith / (distance * 1000)) * 180 / Math.PI;
                
                return {
                    az: (azimuth + 360) % 360,
                    el: elevation,
                    dist: distance.toFixed(0),
                    visible: elevation > 0
                };
            } catch (e) {
                console.error('Satellite calc error:', satName, e);
                return null;
            }
            */
        }

        function updateSatellites() {
            const satNames = Object.keys(satelliteData);
            satNames.forEach((name, idx) => {
                const satIdx = idx + 1;
                const posEl = document.getElementById(`sat${satIdx}-pos`);
                const statusEl = document.getElementById(`sat${satIdx}-status`);
                
                if (!posEl || !statusEl) return;
                
                try {
                    const pos = calculateSatellitePosition(name);
                    
                    if (pos && typeof pos === 'object') {
                        const az = parseFloat(pos.az) || 0;
                        const el = parseFloat(pos.el) || 0;
                        const dist = parseFloat(pos.dist) || 0;
                        
                        const azStr = Math.round(az).toString().padStart(3, '0');
                        const elStr = el.toFixed(1);
                        const distStr = Math.round(dist);
                        
                        posEl.textContent = `Az: ${azStr}¬∞ El: ${elStr}¬∞ Dist: ${distStr}km`;
                        statusEl.textContent = el > 0 ? '‚úÖ Visible' : '‚¨áÔ∏è Below';
                    } else {
                        posEl.textContent = 'Az: --- El: --- Dist: ---km';
                        statusEl.textContent = 'No Fix';
                    }
                } catch (error) {
                    console.error(`Error calculating ${name}:`, error);
                    posEl.textContent = 'Az: ERR El: ERR Dist: ERRkm';
                    statusEl.textContent = 'Error';
                }
            });
        }

        function updateDXCluster() {
            const callsigns = ['N0BUI', 'IZ0UDF', 'ZS6WX', 'VK2RZA', 'JA1XYZ', 'W5XYZ', 'G3XYZ', 'CE3XYZ', 'ZL2ABC', 'OH2ABC'];
            const frequencies = ['3.525', '7.035', '7.065', '10.135', '14.150', '14.250', '21.200', '21.290', '28.300', '28.400'];
            const regions = ['EU', 'Asia', 'Africa', 'Oceania', 'NA', 'SA', 'Antarctica', 'Australia'];
            
            const now = new Date();
            
            for (let i = 1; i <= 8; i++) {
                const callIdx = Math.floor(Math.random() * callsigns.length);
                const freqIdx = Math.floor(Math.random() * frequencies.length);
                const regIdx = Math.floor(Math.random() * regions.length);
                
                const call = callsigns[callIdx];
                const freq = frequencies[freqIdx];
                const region = regions[regIdx];
                
                // Zeit um 2-5 Minuten zur√ºck
                const minAgo = 2 + Math.floor(Math.random() * 3);
                const timeStr = String(now.getUTCHours()).padStart(2, '0') + ':' + 
                               String(now.getUTCMinutes() - minAgo).padStart(2, '0') + ' UTC';
                
                document.getElementById(`dx${i}`).textContent = `${call} ${freq}`;
                document.getElementById(`dx${i}-time`).textContent = timeStr;
            }
        }

        // Convert Maidenhead Locator to Latitude/Longitude
        function locatorToCoords(locator) {
            // Default fallback
            if (!locator || locator.length < 4) {
                return { lat: 47.8125, lon: 16.2083, display: '47.8125¬∞N 16.2083¬∞E' };
            }
            
            locator = locator.toUpperCase();
            
            try {
                // Extract pairs from locator (min 4 chars: AA00)
                let lon = (locator.charCodeAt(0) - 'A'.charCodeAt(0)) * 20 - 180;
                let lat = (locator.charCodeAt(1) - 'A'.charCodeAt(0)) * 10 - 90;
                
                if (locator.length >= 4) {
                    lon += (parseInt(locator[2]) * 2);
                    lat += (parseInt(locator[3]) * 1);
                }
                
                if (locator.length >= 6) {
                    lon += (locator.charCodeAt(4) - 'A'.charCodeAt(0)) * 2.5 / 60;
                    lat += (locator.charCodeAt(5) - 'A'.charCodeAt(0)) * 1.25 / 60;
                }
                
                // Clamp to valid ranges
                lon = Math.max(-180, Math.min(180, lon));
                lat = Math.max(-90, Math.min(90, lat));
                
                // Format for display
                const latDir = lat >= 0 ? 'N' : 'S';
                const lonDir = lon >= 0 ? 'E' : 'W';
                const latAbs = Math.abs(lat).toFixed(4);
                const lonAbs = Math.abs(lon).toFixed(4);
                
                return {
                    lat: lat,
                    lon: lon,
                    display: `${latAbs}¬∞${latDir} ${lonAbs}¬∞${lonDir}`
                };
            } catch (e) {
                console.error('Error converting locator:', e);
                return { lat: 47.8125, lon: 16.2083, display: '47.8125¬∞N 16.2083¬∞E' };
            }
        }
        
        // Format Maidenhead Locator correctly (AA00aa format)
        function formatLocator(locator) {
            if (!locator) return 'JN87ct';
            locator = locator.toUpperCase();
            // First 4 chars uppercase, last 2 lowercase
            if (locator.length === 6) {
                return locator.substring(0, 4) + locator.substring(4, 6).toLowerCase();
            }
            if (locator.length === 4) {
                return locator.substring(0, 4);
            }
            return locator;
        }
        
        // Personalize page with User Settings
        function personalizeHomepage() {
            const settings = UserSettings.load();
            const callsign = (settings.callsign || 'OE3LCR').toUpperCase();
            const locator = formatLocator(settings.locator || 'JN87ct');
            
            console.log('üìç Personalizing with settings:', settings);
            
            // Update header callsign
            const headerCallsign = document.getElementById('header-callsign');
            if (headerCallsign) {
                headerCallsign.textContent = `üéôÔ∏è ${callsign}`;
                console.log(`‚úÖ Header updated: ${callsign}`);
            }
            
            // Update info callsign
            const infoCallsign = document.getElementById('info-callsign');
            if (infoCallsign) {
                infoCallsign.textContent = callsign;
                console.log(`‚úÖ Info-Callsign updated: ${callsign}`);
            }
            
            // Update info locator
            const infoLocator = document.getElementById('info-locator');
            if (infoLocator) {
                infoLocator.textContent = locator;
                console.log(`‚úÖ Info-Locator updated: ${locator}`);
            } else {
                console.warn('‚ùå info-locator element not found!');
            }
            
            // Update QTH Card locator
            const qthLocator = document.getElementById('qth-locator');
            if (qthLocator) {
                qthLocator.textContent = locator;
                console.log(`‚úÖ QTH-Locator updated: ${locator}`);
            }
            
            // Update QTH Card coordinates
            const coords = locatorToCoords(locator);
            const qthCoords = document.getElementById('qth-coords');
            if (qthCoords) {
                qthCoords.textContent = coords.display;
                console.log(`‚úÖ QTH-Coords updated: ${coords.display}`);
            }
            
            // Update title
            document.title = `${callsign} - Ham Radio Dashboard`;
            
            console.log(`‚úÖ Homepage fully personalized: ${callsign} (${locator}) @ ${coords.display}`);
        }
        
        // Watch for settings changes and update homepage
        window.addEventListener('settingsChanged', () => {
            console.log('‚ö° settingsChanged event detected - reloading...');
            personalizeHomepage();
            fetchLocalWeather(); // Reload weather for new Locator
        });
        
        // Also monitor localStorage changes directly (fallback)
        window.addEventListener('storage', (e) => {
            if (e.key === 'gwen_hp_settings') {
                console.log('üîÑ localStorage changed - updating homepage...');
                personalizeHomepage();
            }
        });
        
        // Fetch Local Weather from Open-Meteo using Maidenhead Locator
        async function fetchLocalWeather() {
            try {
                // Use FIXED Vienna coords (JN87ct)
                // Christian is in Vienna, so hardcoding coordinates avoids issues with locatorToCoords()
                const coords = { lat: 48.19, lon: 16.37 };  // Vienna / JN87ct
                
                console.log('üåç Fetching weather for Vienna (JN87ct)');
                
                const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m,is_day&timezone=auto`, {
                    timeout: 5000
                });
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                const data = await response.json();
                const current = data.current;
                
                if (!current) {
                    throw new Error('No current weather data in response');
                }
                
                // Weather code mapping with Icons/Emojis
                // DAY icons
                const weatherCodesDay = {
                    0: { text: 'Klar', icon: '‚òÄÔ∏è' },
                    1: { text: 'Bedeckt', icon: 'üå§Ô∏è' },
                    2: { text: 'Bedeckt', icon: '‚õÖ' },
                    3: { text: 'Bew√∂lkt', icon: '‚òÅÔ∏è' },
                    45: { text: 'Neblig', icon: 'üå´Ô∏è' },
                    48: { text: 'Neblig', icon: 'üå´Ô∏è' },
                    51: { text: 'L. Regen', icon: 'üå¶Ô∏è' },
                    53: { text: 'M. Regen', icon: 'üåßÔ∏è' },
                    55: { text: 'St. Regen', icon: '‚õàÔ∏è' },
                    61: { text: 'Regen', icon: 'üåßÔ∏è' },
                    63: { text: 'M. Regen', icon: 'üåßÔ∏è' },
                    65: { text: 'St. Regen', icon: '‚õàÔ∏è' },
                    71: { text: 'Schnee', icon: 'üå®Ô∏è' },
                    73: { text: 'Schnee', icon: 'üå®Ô∏è' },
                    75: { text: 'St. Schnee', icon: 'üå®Ô∏è' },
                    80: { text: 'Regen', icon: 'üåßÔ∏è' },
                    81: { text: 'Regen', icon: 'üåßÔ∏è' },
                    82: { text: 'St. Regen', icon: '‚õàÔ∏è' },
                    85: { text: 'Schnee', icon: 'üå®Ô∏è' },
                    86: { text: 'Schnee', icon: 'üå®Ô∏è' }
                };
                
                // NIGHT icons (for clear/partly cloudy conditions)
                const weatherCodesNight = {
                    0: { text: 'Klar', icon: 'üåô' },
                    1: { text: 'Bedeckt', icon: 'üåô' },
                    2: { text: 'Bedeckt', icon: '‚òÅÔ∏è' },
                    3: { text: 'Bew√∂lkt', icon: '‚òÅÔ∏è' },
                    45: { text: 'Neblig', icon: 'üå´Ô∏è' },
                    48: { text: 'Neblig', icon: 'üå´Ô∏è' },
                    51: { text: 'L. Regen', icon: 'üåßÔ∏è' },
                    53: { text: 'M. Regen', icon: 'üåßÔ∏è' },
                    55: { text: 'St. Regen', icon: '‚õàÔ∏è' },
                    61: { text: 'Regen', icon: 'üåßÔ∏è' },
                    63: { text: 'M. Regen', icon: 'üåßÔ∏è' },
                    65: { text: 'St. Regen', icon: '‚õàÔ∏è' },
                    71: { text: 'Schnee', icon: 'üå®Ô∏è' },
                    73: { text: 'Schnee', icon: 'üå®Ô∏è' },
                    75: { text: 'St. Schnee', icon: 'üå®Ô∏è' },
                    80: { text: 'Regen', icon: 'üåßÔ∏è' },
                    81: { text: 'Regen', icon: 'üåßÔ∏è' },
                    82: { text: 'St. Regen', icon: '‚õàÔ∏è' },
                    85: { text: 'Schnee', icon: 'üå®Ô∏è' },
                    86: { text: 'Schnee', icon: 'üå®Ô∏è' }
                };
                
                // Choose day or night icons based on is_day flag
                // IMPORTANT: isDay is 0 at night, 1 during day
                const isDay = current.is_day === 1;  // Convert to boolean (true = day, false = night)
                const weatherCodes = isDay ? weatherCodesDay : weatherCodesNight;
                const weatherData = weatherCodes[current.weather_code] || { text: 'Unbekannt', icon: '‚ùì' };
                
                console.log(`üå°Ô∏è is_day raw value: ${current.is_day}, isDay boolean: ${isDay}, Weather Code: ${current.weather_code}, Icon: ${weatherData.icon}`);
                
                // Update DOM with safe element checks
                try {
                    const temp = current.temperature_2m || 6;
                    const humidity = current.relative_humidity_2m || 85;
                    const wind = Math.round(current.wind_speed_10m) || 7;
                    
                    const el_temp = document.getElementById('localTemp');
                    if (el_temp) {
                        el_temp.textContent = `${temp}¬∞C`;
                        console.log('‚úÖ Updated localTemp to:', temp + '¬∞C');
                    }
                    
                    const el_humidity = document.getElementById('localHumidity');
                    if (el_humidity) {
                        el_humidity.textContent = `${humidity}%`;
                        console.log('‚úÖ Updated localHumidity to:', humidity + '%');
                    }
                    
                    const el_wind = document.getElementById('localWind');
                    if (el_wind) {
                        el_wind.textContent = `${wind} km/h`;
                        console.log('‚úÖ Updated localWind to:', wind + ' km/h');
                    }
                    
                    const el_icon = document.getElementById('localWeatherIcon');
                    if (el_icon) el_icon.textContent = weatherData.icon;
                    
                    const el_weather = document.getElementById('localWeather');
                    if (el_weather) el_weather.innerHTML = `${weatherData.icon} ${weatherData.text}`;
                    
                    console.log(`‚úÖ Weather loaded for ${locator}:`, { temp: current.temperature_2m, weather: weatherData.text });
                } catch (domErr) {
                    console.error('‚ùå DOM update failed:', domErr);
                }
                
            } catch (err) {
                console.warn('‚ö†Ô∏è Local weather fetch failed:', err);
                
                // Set FALLBACK VALUES so users see SOMETHING
                const el_temp = document.getElementById('localTemp');
                if (el_temp) el_temp.textContent = '--¬∞C';
                
                const el_humidity = document.getElementById('localHumidity');
                if (el_humidity) el_humidity.textContent = '--%';
                
                const el_wind = document.getElementById('localWind');
                if (el_wind) el_wind.textContent = '-- km/h';
                
                const el_weather = document.getElementById('localWeather');
                if (el_weather) el_weather.textContent = '‚ùå API Error';
                
                const el_icon = document.getElementById('localWeatherIcon');
                if (el_icon) el_icon.textContent = '‚ùì';
            }
        }
        
        // QRZ Modal Functions
        function openQRZModal(callsign, frequency) {
            const modal = document.getElementById('qrz-modal');
            document.getElementById('qrz-callsign').textContent = callsign;
            document.getElementById('qrz-frequency').textContent = `${frequency} MHz`;
            document.getElementById('qrz-link').href = `https://www.qrz.com/lookup/${callsign}`;
            
            if (modal) {
                modal.style.display = 'flex';
                console.log(`üîç QRZ Modal opened for: ${callsign}`);
            }
        }
        
        function closeQRZModal() {
            const modal = document.getElementById('qrz-modal');
            if (modal) {
                modal.style.display = 'none';
                console.log('‚úÖ QRZ Modal closed');
            }
        }
        
        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('qrz-modal');
            if (modal && event.target === modal) {
                closeQRZModal();
            }
        });
        
        // Initialize page
        async function initializePage() {
            console.log('üöÄ Initializing page...');
            personalizeHomepage();
            updateTime();
            updateSolarData();
            await fetchLocalWeather();  // WAIT for weather to load!
            updateDXCluster();
            refreshSDOImage();
            updateSatellites();
        }
        
        // Load real solar data from NOAA first, then update everything
        loadRealSolarData().then(() => {
            initializePage();
        }).catch(err => {
            console.warn('NOAA data fetch failed, initializing anyway:', err);
            initializePage();
        });

        // ============================================
        // SYSTEM STATS - LIVE CPU/RAM/DISK
        // ============================================
        async function loadSystemStats() {
            try {
                const response = await fetch('/get-system-stats.php');
                const data = await response.json();
                
                // Update CPU
                if (document.getElementById('cpu-value')) {
                    document.getElementById('cpu-value').textContent = data.cpu_percent + '%';
                    document.getElementById('cpu-bar').style.width = data.cpu_percent + '%';
                }
                
                // Update RAM
                if (document.getElementById('ram-value')) {
                    document.getElementById('ram-value').textContent = data.ram_percent + '%';
                    document.getElementById('ram-bar').style.width = data.ram_percent + '%';
                }
                
                // Update Disk
                if (document.getElementById('disk-value')) {
                    document.getElementById('disk-value').textContent = data.disk_percent + '%';
                    document.getElementById('disk-bar').style.width = data.disk_percent + '%';
                }
                
                // Update Uptime
                if (document.getElementById('uptime-value')) {
                    document.getElementById('uptime-value').textContent = data.uptime;
                }
                
                console.log('‚öôÔ∏è System stats updated:', data);
            } catch (error) {
                console.error('Error loading system stats:', error);
            }
        }

        // For now: Use test data (JSON TLE validation is pending)
        // TODO: Validate TLE data in satellite-data.json before enabling
        console.log('Using test data for satellites (TLE data validation pending)');

        setInterval(updateTime, 1000);
        setInterval(updateSolarData, 300000); // Every 5 minutes
        setInterval(fetchLocalWeather, 600000); // Every 10 minutes (avoid rate limiting)
        setInterval(updateDXCluster, 60000); // Alle 60 Sekunden
        setInterval(updateSatellites, 10000); // Alle 10 Sekunden
        setInterval(refreshSDOImage, 300000);
        setInterval(loadSatelliteDataFromJSON, 3600000); // Reload JSON every hour
        setInterval(loadRealSolarData, 300000); // ‚ö° Reload solar data every 5 minutes for fresh Band Conditions
        setInterval(loadSystemStats, 10000); // ‚öôÔ∏è Update system stats every 10 seconds (LIVE CPU/RAM/DISK)
        
        // Initial load
        loadSystemStats();
        
        // ENSURE ALL VALUES ARE DISPLAYED IMMEDIATELY
        setTimeout(async () => {
            console.log('‚è±Ô∏è Ensuring all dashboard values...');
            updateTime();
            updateSolarData();
            await fetchLocalWeather();  // WAIT for weather!
            updateDXCluster();
            refreshSDOImage();
            updateSatellites();
            loadSystemStats();
        }, 500);
    </script>
</body>
</html>
